/*
 * Encoder.c
 *
 *  Created on: Oct 20, 2019
 *      Author: DHKim
 */


/**********************************************************************************************************************
* MODULES USED
**********************************************************************************************************************/
#include "main.h"
#include "Encoder.h"
#include "stm32f7xx_hal.h"

/**********************************************************************************************************************
* DEFINITIONS AND MACROS
**********************************************************************************************************************/

/**********************************************************************************************************************
* TYPEDEFS AND STRUCTURES
**********************************************************************************************************************/

/**********************************************************************************************************************
* PROTOTYPES OF FUNCTIONS
**********************************************************************************************************************/
uint8_t Encoder_Get_Direction(void);


/**********************************************************************************************************************
* DECLARATIONS OF VARIABLES
**********************************************************************************************************************/
extern TIM_HandleTypeDef htim3;

uint32_t Encoder_Z_Counter = 0;
uint32_t Encoder_A_Counter = 0;




/*--------------------------------------------------------------------------*/
/* Name      | Encoder_Test_Count_Up                                        */
/*--------------------------------------------------------------------------*/
void Encoder_Test_Count_Up(void)
{
	Encoder_A_Counter++;
}







/*--------------------------------------------------------------------------*/
/* Name      | Encoder_Init                                                 */
/*--------------------------------------------------------------------------*/
void Encoder_Init(void)
{
    HAL_TIM_Encoder_Start_IT(&htim3, TIM_CHANNEL_1 | TIM_CHANNEL_2);
    HAL_TIM_Base_Start(&htim3);
}

/*--------------------------------------------------------------------------*/
/* Name      | Encoder_Get_A_Counter                                        */
/*--------------------------------------------------------------------------*/
uint32_t Encoder_Get_A_Counter(void)
{
	Encoder_A_Counter += (uint64_t)__HAL_TIM_GET_COUNTER(&htim3);
	htim3.Instance->CNT = 0;	// clear A counter

	return Encoder_A_Counter;
}

/*--------------------------------------------------------------------------*/
/* Name      | Encoder_Clear_Z_Counter                                      */
/*--------------------------------------------------------------------------*/
void Encoder_Clear_Z_Counter(void)
{
	Encoder_Z_Counter = 0;
}

/*--------------------------------------------------------------------------*/
/* Name      | Encoder_Clear_A_Counter                                      */
/*--------------------------------------------------------------------------*/
void Encoder_Clear_A_Counter(void)
{
	Encoder_A_Counter = 0;
	htim3.Instance->CNT = 0;	// clear A counter
}

/*--------------------------------------------------------------------------*/
/* Name      | Encoder_Get_Direction                                        */
/*--------------------------------------------------------------------------*/
uint8_t Encoder_Get_Direction(void)
{
	if (__HAL_TIM_IS_TIM_COUNTING_DOWN(&htim3) == 0)
	{
		return 0x01;	// UpCounter
	}
	else
	{
		return 0x00;	// DownCounter
	}
}

/*--------------------------------------------------------------------------*/
/* Name      | Encoder_Z_Pin_EXTI_Callback                                  */
/*--------------------------------------------------------------------------*/
void Encoder_Z_Pin_EXTI_Callback(GPIO_PinState pinState)
{
	Encoder_Z_Counter += 1;
}

